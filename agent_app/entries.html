<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Collections - Agent App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #121212; color: #eee; font-family: sans-serif; margin: 0; }
    nav {
      background: #1f1f1f; display: flex; flex-wrap: wrap;
      padding: 10px; gap: 10px;
    }
    nav a {
      color: white; background: #333; padding: 10px 15px;
      border-radius: 5px; text-decoration: none;
    }
    nav a:hover { background: #00bcd4; color: black; }
    main { padding: 20px; }
    h1 { color: #00bcd4; }
    input, button, select {
      padding: 10px; margin: 10px 0;
      border-radius: 5px; background: #1e1e1e;
      color: white; border: 1px solid #444; width: 100%;
    }
    button { background: #00bcd4; color: black; font-weight: bold; }
    .customer-box {
      margin-top: 10px; padding: 10px;
      background: #1d1d1d; border: 1px solid #333;
      border-radius: 8px;
    }
    #suggestions {
      background: #222; border: 1px solid #333;
      border-radius: 5px; display: none;
      position: absolute; z-index: 999;
      max-height: 200px; overflow-y: auto;
    }
    #suggestions div {
      padding: 10px; cursor: pointer;
    }
    #suggestions div:hover {
      background: #00bcd4; color: black;
    }
    #productInfo { margin-top: 10px; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="entries.html">Add Collection</a>
    <a href="view.html">Today's Entries</a>
  </nav>

  <main>
    <h1>Add Collection Entry</h1>
    <input type="text" id="searchBox" placeholder="Search by ID, Name or Phone" oninput="showSuggestions(this.value)">
    <div id="suggestions"></div>

    <div class="customer-box" id="customerInfo" style="display:none;">
      <p><strong>ID:</strong> <span id="custId"></span></p>
      <p><strong>Name:</strong> <span id="custName"></span></p>
      <p><strong>Phone:</strong> <span id="custPhone"></span></p>
      <p><strong>Place:</strong> <span id="custPlace"></span></p>

      <div id="productSection">
        <label>Select Product:</label>
        <select id="productDropdown"></select>
        <div id="productInfo"></div>
      </div>

      <input type="number" id="amount" placeholder="Enter Amount Collected">
      <input type="date" id="date">
      <button onclick="saveEntry()">Save Entry</button>
    </div>
  </main>

  <script>
    let customers = JSON.parse(localStorage.getItem('agent_customers') || '[]');
    let entries = JSON.parse(localStorage.getItem('agent_entries') || '[]');
    let selectedCustomer = null;
    let unpaidProducts = [];

    document.getElementById("date").value = new Date().toISOString().split("T")[0];

    function showSuggestions(input) {
      const box = document.getElementById("suggestions");
      if (!input || input.length < 1) return box.style.display = "none";

      const results = customers.filter(c =>
        c.id.toLowerCase().includes(input.toLowerCase()) ||
        c.name.toLowerCase().includes(input.toLowerCase()) ||
        c.phone.includes(input)
      ).slice(0, 10);

      box.innerHTML = results.map(c => `<div onclick="selectCustomer('${c.id}')">${c.id} - ${c.name} (${c.phone})</div>`).join("");
      box.style.display = results.length ? "block" : "none";
    }

    function selectCustomer(id) {
      selectedCustomer = customers.find(c => c.id === id);
      document.getElementById("custId").innerText = selectedCustomer.id;
      document.getElementById("custName").innerText = selectedCustomer.name;
      document.getElementById("custPhone").innerText = selectedCustomer.phone;
      document.getElementById("custPlace").innerText = selectedCustomer.place;
      document.getElementById("customerInfo").style.display = "block";
      document.getElementById("suggestions").style.display = "none";
      document.getElementById("searchBox").value = selectedCustomer.name;

      loadUnpaidProducts();
    }

    function loadUnpaidProducts() {
      const dropdown = document.getElementById("productDropdown");
      const productInfo = document.getElementById("productInfo");
      unpaidProducts = [];

      dropdown.innerHTML = "";
      selectedCustomer.products.forEach((p, index) => {
        let paid = 0;
        if (p.payments && Array.isArray(p.payments)) {
          paid = p.payments.reduce((sum, pay) => sum + pay.amount, 0);
        } else {
          paid = p.paid || 0;
        }

        const balance = p.total - paid;
        if (balance > 0) {
          unpaidProducts.push({ ...p, index, paid, balance });
          dropdown.innerHTML += `<option value="${index}">${p.name} - ₹${balance.toFixed(2)} due</option>`;
        }
      });

      if (unpaidProducts.length === 0) {
        dropdown.innerHTML = "<option>No unpaid products</option>";
        productInfo.innerHTML = `<p>✅ All products fully paid.</p>`;
        document.getElementById("amount").disabled = true;
        document.getElementById("date").disabled = true;
      } else {
        updateProductInfo();
        document.getElementById("amount").disabled = false;
        document.getElementById("date").disabled = false;
      }

      dropdown.onchange = updateProductInfo;
    }

    function updateProductInfo() {
      const selectedIdx = document.getElementById("productDropdown").value;
      const prod = unpaidProducts.find(p => p.index == selectedIdx);
      if (!prod) return;

      document.getElementById("productInfo").innerHTML = `
        <p><strong>Product:</strong> ${prod.name}</p>
        <p><strong>Total:</strong> ₹${prod.total}</p>
        <p><strong>Paid:</strong> ₹${prod.paid}</p>
        <p><strong>Balance:</strong> ₹${prod.balance}</p>
      `;
    }

    function saveEntry() {
      const amt = parseFloat(document.getElementById("amount").value);
      const date = document.getElementById("date").value;
      const prodIndex = parseInt(document.getElementById("productDropdown").value);
      const prod = unpaidProducts.find(p => p.index == prodIndex);

      if (!selectedCustomer || isNaN(amt) || !date || !prod) {
        alert("Please fill all fields");
        return;
      }

      if (amt > prod.balance) {
        alert("Amount exceeds remaining balance!");
        return;
      }

      const product = selectedCustomer.products[prodIndex];
      if (!Array.isArray(product.payments)) product.payments = [];

      const lastDueNumber = product.payments.reduce((max, p) => Math.max(max, p.dueNumber || 0), 0);
      const dueNumber = lastDueNumber + 1;

      const payment = { amount: amt, date, dueNumber };
      product.payments.push(payment);

      const entry = {
        id: selectedCustomer.id,
        name: selectedCustomer.name,
        phone: selectedCustomer.phone,
        product: product.name,
        amount: amt,
        date: date,
        dueNumber: dueNumber
      };

      entries.push(entry);
      localStorage.setItem("agent_entries", JSON.stringify(entries));
      localStorage.setItem("agent_customers", JSON.stringify(customers));
      alert(`✅ Entry saved with Due #${dueNumber}`);

      document.getElementById("customerInfo").style.display = "none";
      document.getElementById("amount").value = "";
      document.getElementById("searchBox").value = "";
      selectedCustomer = null;
      unpaidProducts = [];
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Add Entry</title>
  <meta charset="UTF-8">
  <style>/* same styling as above */</style>
</head>
<body>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="entries.html">Add Entry</a>
    <a href="view.html">View Entries</a>
    <a href="customer_report.html">Customer Report</a>
  </nav>

  <h1>Add Customer Payment</h1>
  <input id="searchBox" placeholder="Search ID/Name/Phone" oninput="searchCustomer()" />
  <div id="customerView"></div>

  <script>
    let customers = JSON.parse(localStorage.getItem('main_customers') || '[]');
    let entries = JSON.parse(localStorage.getItem('agent_entries') || '[]');

    function searchCustomer() {
      const val = document.getElementById("searchBox").value.toLowerCase();
      const match = customers.find(c => c.id.includes(val) || c.name.toLowerCase().includes(val));
      const div = document.getElementById("customerView");
      div.innerHTML = '';

      if (!match) return;

      const html = [`<h3>${match.name} (${match.id})</h3><p>${match.phone} - ${match.place}</p>`];
      match.products.forEach((p, i) => {
        const paid = p.payments?.reduce((sum, a) => sum + a.amount, 0) || 0;
        const balance = p.total - paid;
        const due = (match.paidDues || 0) + (p.payments?.length || 0) + 1;
        html.push(`
          <div>
            <strong>${p.name}</strong><br>
            ₹${p.total} | Paid: ₹${paid} | Balance: ₹${balance}<br>
            <input id="amt_${i}" placeholder="Amount">
            <input id="date_${i}" type="date" value="${new Date().toISOString().split('T')[0]}">
            <button onclick="saveEntry('${match.id}', '${p.name}', ${i})">Save</button>
          </div>
        `);
      });
      div.innerHTML = html.join('<br>');
    }

    function saveEntry(id, product, i) {
      const amt = parseFloat(document.getElementById(`amt_${i}`).value);
      const date = document.getElementById(`date_${i}`).value;
      if (!amt || !date) return alert("❌ Fill all fields");

      const customer = customers.find(c => c.id === id);
      const prod = customer.products.find(p => p.name === product);
      const due = (customer.paidDues || 0) + (prod.payments?.length || 0) + 1;

      entries.push({ id, name: customer.name, phone: customer.phone, product, amount: amt, date, dueNumber: due });
      localStorage.setItem("agent_entries", JSON.stringify(entries));
      alert("✅ Entry added.");
    }
  </script>
</body>
</html>
